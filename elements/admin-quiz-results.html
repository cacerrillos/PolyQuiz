<!doctype html>
<dom-module id="sort-button">
<template>
	<paper-button id="noSort" on-click="onClick">Sort</paper-button>
	<paper-button id="sortAsc" on-click="onClick">Sort<iron-icon icon="icons:arrow-drop-up"></iron-icon></paper-button>
	<paper-button id="sortDesc" on-click="onClick">Sort<iron-icon icon="icons:arrow-drop-down"></iron-icon></paper-button>
</template>
<script>
Polymer({
	is: "sort-button",
	properties: {
		state: {
			type: Number,
			value: 0
		}
	},
	ready: function(){
		this.redraw();
	},
	redraw: function(){
		this.$.noSort.style.display = "none";
		this.$.sortAsc.style.display = "none";
		this.$.sortDesc.style.display = "none";
		switch(this.state){
			case 0:
				this.$.noSort.style.display = "block";
				break;
			case 1:
				this.$.sortAsc.style.display = "block";
				break;
			case 2:
				this.$.sortDesc.style.display = "block";
				break;
		}
	},
	onClick: function(e){
		this.state++;
		if(this.state > 2){
			this.state = 0;
		}
		this.redraw();
		this.fire('sort-button-changed', { state: this.state });
	}
});
</script>
</dom-module>
<dom-module id="admin-quiz-results-house">
<style is="custom-style">
		paper-material {
			background-color: white;
			margin-top: 5px;
			margin-bottom: 5px;
		}
	</style>
<template>
	<div class="row" id="mainDiv">
		<div class="12u">
			<paper-material>
				<h2><span>[[quizname]]</span> - <span>[[house]]</span></h2>
				<div class="row">
					<div class="12u">
						<div class="row">
							<div class="12u">
								<paper-material>
									<div class="row">
										<div class="4u">
											<div class="row">
											
												<div class="12u"><span>[[sortState]]</span>Last Name</div>
												<div class="12u"><span style="padding-left:20px;">First Name</span></div>
											</div>
										</div>
										<div class="3u">
											<div class="row">
												<div class="6u">Regular:</div>
												<div class="6u"><sort-button on-sort-button-changed="handleSort"></sort-button></div>
												<div class="6u">Free Response:</div>
												<div class="6u"></div>
											</div>
										</div>
										<div class="3u">Date &amp; Time</div>
										<div class="2u" id="actionButtons">
											
										</div>
									</div>
								</paper-material>
							</div>
							</div>
						<template is="dom-repeat" items="[[quizdata]]" as="quizresults" sort="sortData" id="resultsTemplate" observe="sortState">
							<admin-quiz-results-row
								uuid="[[quizresults.uuid]]"
								firstname="[[quizresults.firstname]]"
								lastname="[[quizresults.lastname]]"
								score="[[quizresults.rawscore]]"
								possiblescore="[[quizresults.possiblescore]]"
								freeresponsescore="[[quizresults.frscore]]"
								freeresponsescorepossible="[[quizresults.frpossible]]"
								datetime="[[quizresults.timestamp]]"
								house="[[quizresults.house]]"
								></admin-quiz-results-row>
						</template>
					</div>
				</div>
			</paper-material>
		</div>
	</div>
</template>
<script>
	Polymer({
		is: "admin-quiz-results-house",
		properties: {
			quizname: String,
			house: String,
			quizdata: {
				type: Array,
				observer: "dataChanged"
			},
			sortState: {
				type: Number,
				value: 0
			}
		},
		dataChanged: function(){
			if(!this.quizdata){
				this.$.mainDiv.style.display = "none";
			} else {
				this.$.mainDiv.style.display = "block";
			}
		},
		sortData: function(a, b){
			switch(this.sortState){
				case 0:
					return 0;
				case 1:
					if(a.rawscore === b.rawscore) return 0;
					return a.rawscore < b.rawscore ? -1 : 1;
				case 2:
					if(a.rawscore === b.rawscore) return 0;
					return a.rawscore > b.rawscore ? -1 : 1;
			}
		},
		handleSort: function(e){
			this.sortState = e.detail.state;
			this.$.resultsTemplate.render();
		},
		ready: function(){
			this.dataChanged();
		}
	});
</script>
</dom-module>
<dom-module id="admin-quiz-results-page">
	<link rel="import" href="admin-quiz-results/admin-quiz-results-delete-overlay.html">
	<link rel="import" href="admin-quiz-results/admin-quiz-results-row.html">
	<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
	<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
	<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
	<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
	<link rel="import" href="../bower_components/neon-animation/animations/scale-up-animation.html">
	<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
	<style is="custom-style">
		paper-material {
			background-color: white;
			margin-top: 5px;
			margin-bottom: 5px;
		}
	</style>
	<template>
		<iron-ajax
				id="resultsAjax"
				url="../api/1.0/results.php"
				handle-as="json"
				on-response="resultContentReceived">	
			</iron-ajax>
		<div class="container" id="thisPageContainer">
			<div class="row">
				<div class="12u">
					<paper-material>
						<h2 class="nomargins">Results & Grading</h2>
						Sort By: <paper-button id="quizandhouse" on-click="onSortByQuizAndHouse" raised>Quiz & House</paper-button><paper-button id="session" on-click="onSortBySession" raised>Session</paper-button>
						<paper-menu-button>
							<paper-button>View</paper-button>
						</paper-menu-button>
					</paper-material>
				</div>
				<div class="12u" id="loadPaperDiv">
					<paper-material id="loadPaper">
						<center><paper-spinner id="loadSpinner" active></paper-spinner></center>
					</paper-material>
				</div>
			</div>
			<div id="resultRows">
				<admin-quiz-results-house quizname="[[quizName]]" house="North" quizdata="[[_transformData(northData)]]" on-result-deleted="doReload"></admin-quiz-results-house>
				<admin-quiz-results-house quizname="[[quizName]]" house="South" quizdata="[[_transformData(southData)]]" on-result-deleted="doReload"></admin-quiz-results-house>
				<admin-quiz-results-house quizname="[[quizName]]" house="East" quizdata="[[_transformData(eastData)]]" on-result-deleted="doReload"></admin-quiz-results-house>
				<admin-quiz-results-house quizname="[[quizName]]" house="West" quizdata="[[_transformData(westData)]]" on-result-deleted="doReload"></admin-quiz-results-house>
				<admin-quiz-results-house quizname="[[quizName]]" house="Other" quizdata="[[_transformData(otherData)]]" on-result-deleted="doReload"></admin-quiz-results-house>
			</div>
		</div>
	</template>
	<script>
		Polymer({
			is: "admin-quiz-results-page",
			properties: {
				uuid: String,
				_get: {
					type: Object
				},
				quizName: String,
				northData: Object,
				southData: Object,
				eastData: Object,
				westData: Object,
				otherData: Object,
				resultsObject: {
					type: Array
				}
			},
			resultContentReceived: function(response) {
				this.resultsObject = this.$.resultsAjax.lastResponse;
				var conv = this._transformData(this.resultsObject);
				this.quizName = conv[0].name;
				if(conv[0].results.North){
					this.northData = conv[0].results.North;
				}
				if(conv[0].results.South){
					this.southData = conv[0].results.South;
				}
				if(conv[0].results.East){
					this.eastData = conv[0].results.East;
				}
				if(conv[0].results.West){
					this.westData = conv[0].results.West;
				}
				if(conv[0].results.Other){
					this.otherData = conv[0].results.Other;
				}
				this.$.loadPaperDiv.style.display = "none";
				this.$.resultRows.style.display = "block";
			},
			_transformData: function(data){
				var arr = $.map(data, function(el) { return el; })
				//console.log(arr);
				return arr;
			},
			_convertTimeStamp: function(data) {
				
			},
			_count: function(data){
				return data.length;
			},
			onSortByQuizAndHouse: function() {
				window.location = "?p=results";
			},
			onSortBySession: function(){
				window.location = "?p=results&sortby=session";
			},
			doReload: function(){
				this.$.resultRows.style.display = "none";
				this.$.loadPaperDiv.style.display = "block";
				this.$.resultsAjax.params = { "uuid": this.uuid };
				this.$.resultsAjax.generateRequest();
			},
			ready: function() {
				if(this._get.hasOwnProperty("uuid")){
					this.uuid = this._get["uuid"];
				} else {
					console.log("no uuid!");
				}
				if(this._get.hasOwnProperty("sortby")){
					if(this._get["sortby"] == "session"){
						this.$.session.disabled = true;
					} else {
						this.$.quizandhouse.disabled = true;
					}
				} else {
					this.$.quizandhouse.disabled = true;
				}
				this.doReload();
			}
		});
	</script>

</dom-module>