<!DOCTYPE html>
<dom-module id="polyquiz-page-sessions">
	<link rel="import" href="../../bower_components/polymer/polymer.html">
	<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
	<link rel="import" href="polyquiz-admin-house-manage-form.html">
	<link rel="import" href="polyquiz-admin-session-delete-prompt.html">
	<link rel="import" href="polyquiz-admin-session-action-buttons.html">
	<link rel="import" href="polyquiz-admin-session-create-form.html">
	<link rel="import" href="polyquiz-admin-session-row.html">
	
	<style is="custom-style">
		paper-material {
			background-color: white;
			padding: 5px;
			margin-top: 5px;
			margin-bottom: 5px;
		}
		paper-fab.add {
			position: absolute;
			top: -28px;
			right: 8px;
			z-index: 5;
		}
		paper-dialog {
			background-color: white;
		}
	</style>
	
	<template>
		<iron-ajax id="query" url="../../api/1.0/sessions/owned.php" handle-as="json" on-response="onResp"></iron-ajax>
		<div class="container">
			<iron-pages id="pageSelector" attrForSelected="data-subpage" selected="[[sessionSubpage]]">
				<div>
					<polyquiz-admin-session-create-form id="newSessionDialog"></polyquiz-admin-session-create-form>
					<div class="row" style="padding-top: 28px;">
						<div class="12u">
							<paper-material>
							<paper-fab icon="icons:add" class="add" on-click="doAddNewSession"></paper-fab>
									<div class="row">
										<div class="12u">
											<paper-material  elevation="0" style="margin-bottom: 16px;">
												<div class="row">
													<div class="4u 5u(small) 4u(xsmall)">
														<div class="row">
															<div class="12u">Session Name</div>
															<div class="-2u 10u">Quiz Name</div>
														</div>
													</div>
													<div class="2u">
														<div class="row">
															<div class="12u">Id</div>
															<div class="12u">Key</div>
														</div>
													</div>
													<div class="2u 3u(xsmall)">Date</div>
													<div class="1u">House</div>
													<div class="3u 2u(small)">
													</div>
												</div>
											</paper-material>
										</div>
									</div>
									<center><paper-spinner id="rowSpinner" active></paper-spinner></center>
									<div id="rowWrapper">
										<template id="sessionRows" is="dom-repeat" items="[[sessions]]" as="session" on-dom-change="spinnerOff">
											<polyquiz-admin-session-row sessionobject="[[session]]" on-session-deleted="reloadSessions"></polyquiz-admin-session-row>
										</template>
									</div>
									<polyquiz-admin-house-manage-form></polyquiz-admin-house-manage-form>
							</paper-material>
						</div>
					</div>
				</div>
				
			</iron-pages>
		</div>
	</template>

	<script>
		Polymer({
			is: 'polyquiz-page-sessions',
			behaviors: [
				Polymer.NeonAnimatableBehavior
			],
			properties: {
				sessions: Array,
				ctx: {
					type: Object,
					observer: "onContextChanged"
				},
				isAdmin: {
					type: Boolean,
					value: false
				},
				adminStatus: {
					type: Object
				}
			},
			listeners: {
				'reload-sessions': 'reloadSessions'
			},
			doAddNewSession: function() {
				this.$.newSessionDialog.open();
			},
			onResp: function(e){
				this.sessions = e.detail.response;
			},
			spinnerOff: function(e){
				this.$.rowSpinner.active = false;
				this.$.rowSpinner.style.display = "none";
				this.$.rowWrapper.style.display = "block";
			},
			reloadSessions: function(e){
				this.$.query.generateRequest();
				this.$.rowSpinner.active = true;
				this.$.rowSpinner.style.display = "block";
				this.$.rowWrapper.style.display = "none";
			},
			onContextChanged: function(details) {
				this.loginOverlayCheck();
				return;
				if(details.params.subpage != null) {
					switch(details.params.subpage) {
						default:
							this.$.pageSelector.select(0);
					}
				} else {
					this.$.pageSelector.select(0);
				}
			},
			onAdminStatusChanged: function(e) {
				var details = e.detail;
				this.adminStatus = e.detail;
				this.isAdmin = details.admin;
				this.loginOverlayCheck();
			},
			loginOverlayCheck: function(e) {
				var mainapp = document.querySelector("#mainapp");
				if(this.parentNode.selectedItem == this) {
					if(mainapp.isAdmin) {
						mainapp.closeLoginOverlay();
						return;
					}
					mainapp.openLoginOverlay();
				}
			},
			ready: function() {
				this.$.pageSelector.select(0);
				var mainapp = document.querySelector("#mainapp");
				mainapp.addEventListener('polyquiz-admin-status', this.onAdminStatusChanged.bind(this));

				var parentSelector = this.parentNode;

				parentSelector.addEventListener('iron-select', this.loginOverlayCheck.bind(this));
				this.reloadSessions();
			}
		});
	</script>
</dom-module>