<!doctype html>
<dom-module id="stats-ajax">
<link rel="import" href="../bower_components/iron-signals/iron-signals.html">
<template>
<iron-ajax id="query" url="../api/1.0/quizresults/stats.php" handle-as="json" on-response="onResp"></iron-ajax>
<paper-button on-click="hanClick"><span id="totalshow" style="display:none;">TOTAL</span><span>[[house]]</span><br><span style="">[[count]]</span></paper-button>
</template>
<script>
	Polymer({
		is: 'stats-ajax',
		properties: {
			total: Boolean,
			count: {
				type: Number,
				value: -1
			},
			uuid: String,
			house : {
				type: String,
				value: ""
			}
		},
		hanClick: function(){
			if(this.count == 0){
					this.zeroResultsToast();
				} else {
					if(this.house == ""){
						window.location = "?p=results&uuid=" + this.uuid;
					} else {
						window.location = "?p=results&uuid=" + this.uuid + "&house=" + this.house;
					}
					
				}
		},
		zeroResultsToast: function() {
			this.fire('iron-signal', {name: 'toast-event', data: { toastString: "There are 0 results!" } });
		},
		onResp: function(e){
			var count = e.detail.response.count;
			var latest = e.detail.response.latest;
			this.count = count;
		},
		ready: function(){
			if(this.total){
				this.$.totalshow.style.display = "inline";
			}
			if(this.house!=""){
				this.$.query.params = {
					uuid: this.uuid,
					house: this.house
				};
			} else {
				this.$.query.params = {
					uuid: this.uuid
				};
			}
			this.$.query.generateRequest();
		}
	});
</script>
</dom-module>
<dom-module id="admin-quiz-management-page">
	<link rel="import" href="admin-quiz-results/admin-quiz-results-delete-overlay.html">
	<link rel="import" href="admin-quiz-results/admin-quiz-results-row.html">
	<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
	<link rel="import" href="../bower_components/iron-icons/image-icons.html">
	<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
	<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
	<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
	<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
	<link rel="import" href="../bower_components/neon-animation/animations/scale-up-animation.html">
	<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
	<style is="custom-style">
		paper-material {
			background-color: white;
			margin-top: 5px;
			margin-bottom: 5px;
		}
	</style>
	<template>
		<iron-ajax
				id="resultsAjax"
				url="../api/1.0/quiz/quizinfo.php"
				handle-as="json"
				on-response="resultContentReceived">	
			</iron-ajax>
		<div class="container" id="thisPageContainer">
			<div class="row">
				<div class="12u">
					<paper-material>
						<h2 class="nomargins">My Quizzes</h2>
					</paper-material>
				</div>
				<div class="12u" id="loadPaperDiv">
					<paper-material id="loadPaper">
						<center><paper-spinner id="loadSpinner" active></paper-spinner></center>
					</paper-material>
				</div>
			</div>
			<template is="dom-repeat" items="[[_transformData(resultsObject)]]" as="quizzes">
				<div class="row">
					<div class="12u">
						<paper-material>
							
				<iron-ajax id="southCountAjax" url="../api/1.0/quizresults/stats.php" handle-as="json" on-response="southCountR"></iron-ajax>
				<iron-ajax id="eastCountAjax" url="../api/1.0/quizresults/stats.php" handle-as="json" on-response="eastCountR"></iron-ajax>
				<iron-ajax id="westCountAjax" url="../api/1.0/quizresults/stats.php" handle-as="json" on-response="westCountR"></iron-ajax>
				<iron-ajax id="otherCountAjax" url="../api/1.0/quizresults/stats.php" handle-as="json" on-response="otherCountR"></iron-ajax>
							<h2 class="nomargins">[[quizzes.name]]</h2>
							<h6 class="nomargins" style="display:none;">[[quizzes.uuid]]</h6>
							<div class="row not-small">
								<div class="1u 2u(small)">
									<stats-ajax uuid="[[quizzes.uuid]]" total></stats-ajax>
								</div>
								<div class="1u">
									<stats-ajax uuid="[[quizzes.uuid]]" house="North"></stats-ajax>
								</div>
								<div class="1u">
									<stats-ajax uuid="[[quizzes.uuid]]" house="South"></stats-ajax>
								</div>
								<div class="1u">
									<stats-ajax uuid="[[quizzes.uuid]]" house="East"></stats-ajax>
								</div>
								<div class="1u">
									<stats-ajax uuid="[[quizzes.uuid]]" house="West"></stats-ajax>
								</div>
								<div class="1u">
									<stats-ajax uuid="[[quizzes.uuid]]" house="Other"></stats-ajax>
								</div>
								<div class="1u">
									<center><paper-icon-button icon="editor:insert-chart" alt="Stats" on-click="_goStats"></paper-icon-button></center>
								</div>
								<div class="3u 1u(small)">
									<center>
										<paper-icon-button icon="icons:create" alt="Edit" on-click="_goEditQuiz"></paper-icon-button>
										<paper-icon-button icon="image:remove-red-eye" alt="Preview"></paper-icon-button>
										<paper-icon-button icon="icons:delete" alt="Delete"></paper-icon-button>
									</center>
								</div>
							</div>
							<div class="row only-small">
								<div class="10u">
									<div class="row">
										<div class="3u">
											<center><stats-ajax uuid="[[quizzes.uuid]]" total></stats-ajax></center>
										</div>
										<div class="3u">
											<center><stats-ajax uuid="[[quizzes.uuid]]" house="South"></stats-ajax></center>
										</div>
										<div class="3u">
											<center><stats-ajax uuid="[[quizzes.uuid]]" house="West"></stats-ajax></center>
										</div>
									</div>
									<div class="row">
										<div class="3u">
											<center><stats-ajax uuid="[[quizzes.uuid]]" house="North"></stats-ajax></center>
										</div>
										<div class="3u">
											<center><stats-ajax uuid="[[quizzes.uuid]]" house="East"></stats-ajax></center>
										</div>
										<div class="3u">
											<center><stats-ajax uuid="[[quizzes.uuid]]" house="Other"></stats-ajax></center>
										</div>
									</div>
								</div>
								<div class="2u">
									<center>
										<paper-icon-button icon="icons:create" alt="Edit" on-click="_goEditQuiz"></paper-icon-button>
										<paper-icon-button icon="image:remove-red-eye" alt="Preview"></paper-icon-button>
										<paper-icon-button icon="icons:delete" alt="Delete"></paper-icon-button>
									</center>
								</div>
							</div>
						</paper-material>
					</div>
				</div>
			</template>
		</div>
	</template>
	<script>
		Polymer({
			is: "admin-quiz-management-page",
			properties: {
				_get: {
					type: Object
				},
				resultsObject: {
					type: Array
				}
			},
			resultContentReceived: function(response) {
				this._transformData(this.$.resultsAjax.lastResponse);
				//console.log(this.$.resultsAjax.lastResponse);
				this.resultsObject = this.$.resultsAjax.lastResponse;
				this.$.loadPaperDiv.style.display = "none";
			},
			resultCountReceivedTotal: function(response) {
				//console.log(response);
				response.model.set('quizzes.count', response.detail.response['count']);
			},
			_transformData: function(data){
				var arr = $.map(data, function(el) { return el; })
				//console.log(arr);
				return arr;
			},
			_convertTimeStamp: function(data) {
				
			},
			resultsTotal: function(e){
				if(e.model.get('quizzes.totalcount') == 0){
					this.zeroResultsToast();
				} else {
					window.location = "?p=results&uuid=" + e.model.get('quizzes.uuid');
				}
			},
			resultsNorth: function(e){
				if(e.model.get('quizzes.totalcount') == 0){
					this.zeroResultsToast();
				} else {
					window.location = "?p=results&uuid=" + e.model.get('quizzes.uuid');
				}
			},
			northCountR: function(response){
				console.log(response);
				response.model.quizzes.northcount = response.detail.response.count;
				console.log(response.model.quizzes);
				//console.log(response.target.parentElement.parentElement.getElementById(""));
				//console.log(response);
			},
			resultsSouth: function(e){
				if(e.model.get('quizzes.totalcount') == 0){
					this.zeroResultsToast();
				} else {
					window.location = "?p=results&uuid=" + e.model.get('quizzes.uuid');
				}
			},
			resultsEast: function(e){
				if(e.model.get('quizzes.totalcount') == 0){
					this.zeroResultsToast();
				} else {
					window.location = "?p=results&uuid=" + e.model.get('quizzes.uuid');
				}
			},
			resultsWest: function(e){
				if(e.model.get('quizzes.totalcount') == 0){
					this.zeroResultsToast();
				} else {
					window.location = "?p=results&uuid=" + e.model.get('quizzes.uuid');
				}
			},
			resultsOther: function(e){
				if(e.model.get('quizzes.totalcount') == 0){
					this.zeroResultsToast();
				} else {
					window.location = "?p=results&uuid=" + e.model.get('quizzes.uuid');
				}
			},
			_goEditQuiz: function(e){
				window.location = "?p=editquiz&uuid=" + e.model.get('quizzes.uuid');
			},
			_count: function(data){
				return data.length;
			},
			onSortByQuizAndHouse: function() {
				window.location = "?p=results";
			},
			onSortBySession: function(){
				window.location = "?p=results&sortby=session";
			},
			ready: function() {
				this.$.resultsAjax.generateRequest();
			}
		});
	</script>

</dom-module>